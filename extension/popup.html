<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>QuickTranslator</title>
    <style>
      body { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin: 0; padding: 10px; width: 320px; }
      textarea { width: 100%; height: 90px; }
      .row { margin-top: 8px; display: flex; gap: 6px; align-items: center; }
      button { padding: 6px 10px; }
      .hint { color: #666; font-size: 12px; }
    </style>
  </head>
  <body>
    <h3>QuickTranslator</h3>
    <textarea id="src" placeholder="输入或在页面选中文本…"></textarea>
    <div class="row">
      <button id="translate">翻译</button>
      <button id="copy">复制</button>
      <button id="options">设置</button>
      <span id="lang" class="hint"></span>
    </div>
    <textarea id="dst" readonly></textarea>

    <script>
      const els = {
        src: document.getElementById('src'),
        dst: document.getElementById('dst'),
        lang: document.getElementById('lang'),
        translate: document.getElementById('translate'),
        copy: document.getElementById('copy'),
        options: document.getElementById('options')
      };
      const STATE = { targetLang: 'zh', provider: 'mymemory' };

      function load() {
        chrome.storage.sync.get({ targetLang: 'zh', provider: 'mymemory' }, (items) => {
          STATE.targetLang = items.targetLang;
          STATE.provider = items.provider;
          els.lang.textContent = items.targetLang.toUpperCase();
        });
      }

      async function doTranslate() {
        const text = els.src.value.trim();
        if (!text) return;
        els.dst.value = '翻译中…';
        try {
          const resp = await chrome.runtime.sendMessage({
            type: 'qt.translate',
            payload: { text, target: STATE.targetLang, provider: STATE.provider }
          });
          if (resp && resp.ok) {
            els.dst.value = resp.data.translation;
          } else {
            els.dst.value = '翻译失败: ' + (resp?.error || '未知错误');
          }
        } catch (e) {
          els.dst.value = '翻译失败: ' + String(e);
        }
      }

      els.translate.addEventListener('click', doTranslate);
      els.copy.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(els.dst.value); } catch {}
      });
      els.options.addEventListener('click', () => chrome.runtime.openOptionsPage());

      // Try to read selection from active tab
      chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
        if (!tabs[0]) return;
        chrome.scripting.executeScript({
          target: { tabId: tabs[0].id },
          func: () => window.getSelection()?.toString() || ''
        }, (results) => {
          const val = results && results[0] && results[0].result;
          if (val && !els.src.value) {
            els.src.value = val;
          }
        });
      });

      load();
    </script>
  </body>
</html>
